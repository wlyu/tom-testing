var onlyStockAvailable;(function(f){var c="storelocator_section";var d="search";function a(){this.currentPositionCenter=new google.maps.LatLng();this.cgiPosition=null;this.markerStoreLocator=[];this.markerAggregator=[];this.mapStoreLocator=null;this.currentStoreList=[];this.currentAggregatorList=[];this.blockMapStrenght=0;this.isUpdatedBySearch=true;this.movedByBubbleOpening=false;this.currentPositionMarker=null;this.infoBubble=null;this.iScrollList=null;this.enableFilterByCategory=true;this.filterCategorieOpening=true;this.newBounds=new google.maps.LatLngBounds();this.filterOpen=false;this.handlingResize=false;this.enableSavedLocalStorage=true}a.prototype.displayMap=function(o,l,q){console.log("function displayMap");var j=12;if(!o){o=new g()}var m=o.positionCenter,k=o.positionResult;this.fromSearch=o.fromSearch;this.isUpdatedBySearch=o.isUpdatedBySearch;if(k){m=k.geometry.location}else{if(!m){m=new google.maps.LatLng(LATITUDE_HOME,LONGITUDE_HOME);j=RESPONSIVE_MANAGER.isAllSmallMode()?1:2}else{if(m){m=new google.maps.LatLng(LATITUDE_HOME,LONGITUDE_HOME)}}}this.currentPositionCenter=m;var r={center:m,zoom:j,panControl:!is_touch_device(),streetViewControl:!is_touch_device(),zoomControl:!is_touch_device(),mapTypeControl:false,mapTypeId:google.maps.MapTypeId.ROADMAP};var n=window.matchMedia("(min-width: 1025px)").matches;var h={center:m,zoom:j,panControl:!is_touch_device(),streetViewControl:!is_touch_device(),zoomControl:!is_touch_device(),mapTypeControl:false,mapTypeId:google.maps.MapTypeId.ROADMAP,gestureHandling:"cooperative",fullscreenControl:n?true:false};this.setMapHeight();if(l!=undefined&&l!=""){this.mapStoreLocator=new google.maps.Map(document.getElementById(ID_MAP_CANVAS),h)}else{this.mapStoreLocator=new google.maps.Map(document.getElementById(ID_MAP_CANVAS),r)}this.mapStoreLocator.setOptions({styles:[{featureType:"poi.business",stylers:[{visibility:"off"}]}]});if(k){this.mapStoreLocator.fitBounds(k.geometry.viewport);var p=this.getCountryCode(k)}else{p=""}this.shadowTopScoller=f("#shadowTop");if(l!=undefined&&l!=""){this.displayMarkersAtMapCreation(k,m,l,p,q);this.initMapChangeListener(l,p,q)}else{this.displayMarkersAtMapCreation(k,m);this.initMapChangeListener()}if(l==undefined){addExpandMapButton()}f(document).on("pageChanged",(function(){setTimeout(this.handleWindowResize.bind(this),1000)}).bind(this))};a.prototype.handleWindowResize=function(){this.setMapHeight();google.maps.event.trigger(this.mapStoreLocator,"resize");this.handleStoreChangeEvent();this.handlingResize=true;this.enableFilterByCategory=true;this.displayProductCategoryOnrientation()};a.prototype.setMapHeight=function(){var j,h=f("#"+ID_MAP_CANVAS);if(RESPONSIVE_MANAGER.isAllSmallMode()&&isMapExpanded()){return false}if(RESPONSIVE_MANAGER.isAllSmallMode()){h.width("100%").height(MAP_HEIGHT_SMARTPHONE).css("position","relative")}else{if(RESPONSIVE_MANAGER.isLargeMode()){h.css("position","absolute").height("100%")}else{if(RESPONSIVE_MANAGER.isMediumMode()){h.css("position","relative");if(isIdevice&&getCookie(CONFIGURATION.COOKIE_NAME)==="true"){j=getCookie("EndlessIFrameParentHeight")}else{j=f(window).height()}j-=(f("#footer").height()+f("#header").height()+f("#storeResult").outerHeight());if(CONFIGURATION.pageType===c){j-=f("#storeSearch").outerHeight()}else{if(CONFIGURATION.pageType===d){j-=f("#searchResultsHeader").outerHeight();j-=f("#tabsContainer").outerHeight()}}h.height(j)}}}};a.prototype.displayProductCategoryOnrientation=function(){if(RESPONSIVE_MANAGER.isMediumMode()&&isIdevice){if(f(".filterCategoriesContent").length>0&&f(".filterCategoriesContent").is(":visible")){this.closeFilterCategories(500);this.openFilterByCategories(500)}}};a.prototype.displayMarkersAtMapCreation=function(k,n,m,p,q){console.log("function displayMarkersAtMapCreation");if(k){var o=k.geometry.viewport.getNorthEast();var l=k.geometry.viewport.getSouthWest();var h=k.geometry.location;var j=this.getAjaxStoreParameters(h,o,l,this.getCountryCode(k),m,p,q);this.updateStores(j)}else{if(!this.fromSearch){if(FROM_DETAILED_STORE_PAGE){this.updateFromPreviousSate();this.updateFromPreviousSateCatagories()}else{this.handleHomeStoreJsonCall(homeStoreJson)}}}};a.prototype.updateFromPreviousSate=function(){var h=f.jStorage.get("storeLocatorState");this.updateStoreFromJsonObject(h.storeJson);this.mapStoreLocator.setCenter(new google.maps.LatLng(h.lat,h.lng));this.mapStoreLocator.setZoom(h.zoom);getInputTextElement().val(h.inputText);this.displayStoreListTitle(OURFLAGSHIPSTORES);f("#filterCategoriesWrapper").hide();if(h.filterOpen){this.openFilterByCategories(0)}this.checkCategories(h.categoriesChecked)};a.prototype.updateFromPreviousSateCatagories=function(){var h=f.jStorage.get("storeLocatorState");this.checkCategories(h.categoriesChecked);if(h.categoriesChecked||f("#filterCategoriesContent .checkBoxes:checked").length>0){f("#filterCategoriesContent").show()}else{f("#filterCategoriesContent").hide()}};a.prototype.checkCategories=function(h){var j=h.split(";");f(j).each(function(k,n){var m=f("#filterCategoriesContent li[data-value="+n+"] input");for(var l=0;l<m.length;l++){if(!m[l].checked){f(m[l]).click()}}})};a.prototype.handleHomeStoreJsonCall=function(h){this.updateStoreFromJsonObject(h);this.displayStoreListTitle(OURFLAGSHIPSTORES);f("#filterCategoriesWrapper").hide();this.enableFilterByCategory=false};a.prototype.updateStoreFromJsonString=function(j){var h=f.parseJSON(j);this.currentStoreList=h.stores;this.currentAggregatorList=h.aggregator;this.displayMarkers();this.displayAggregator();this.displayStoreList()};a.prototype.displayStoreListTitle=function(h){f("#storeListTitle #"+OURFLAGSHIPSTORES).css("display",h===OURFLAGSHIPSTORES?"block":"none");f("#storeListTitle #"+OURSTORES).css("display",h===OURSTORES?"block":"none")};a.prototype.handleStoreChangeEvent=function(){this.blockMapStrenght=1};a.prototype.initMapChangeListener=function(h,j,k){google.maps.event.addListener(this.mapStoreLocator,"dragend",this.handleStoreChangeEvent.bind(this));google.maps.event.addListener(this.mapStoreLocator,"zoom_changed",this.handleStoreChangeEvent.bind(this));google.maps.event.addListener(this.mapStoreLocator,"click",this.closeBubble.bind(this));if(h==undefined){this.timerUpdateStoreMap(h,j,k)}f("#filterCategoriesContent").off().on("click","li",this.handleClickCheckbox.bind(this));f(".productFilter").on("change",this.handleStoreChangeEvent.bind(this));f("#filterCategoriesHeader").off().on("click",this.clickFilterByCategories.bind(this))};a.prototype.initCategoryFilter=function(){if(typeof initialCategoryFilter!=="undefined"&&initialCategoryFilter!==""){this.checkCategories(decodeURIComponent(initialCategoryFilter));f("#filterCategoriesContent").show();initialCategoryFilter=""}};a.prototype.initCountryFilter=function(){if(typeof initialCountryFilter!=="undefined"&&initialCountryFilter!==""){getInputTextElement().val(initialCountryFilter);f("#buttonSearch").click();initialCountryFilter=""}};a.prototype.handleClickCheckbox=function(j){var h=f(j.currentTarget).find("input");f(window).trigger("checkCategory",{category:this.getCategoriesChecked()});this.blockMapStrenght=1;if(h.is(":checked")){f(j.currentTarget).attr("data-evt-action-id","select_filter")}else{f(j.currentTarget).attr("data-evt-action-id","unselect_filter")}};a.prototype.clickFilterByCategories=function(){if(this.enableFilterByCategory){if(f("#filterCategoriesContent").is(":visible")){this.closeFilterCategories(500)}else{this.openFilterByCategories(500)}}this.saveCurrentStateInLocalStorage()};a.prototype.openFilterByCategories=function(h){this.filterOpen=true;this.filterCategorieOpening=true;f("#filterCategoriesContent").slideToggle(h);f("#filterCategoriesHeader").attr("data-evt-action-id","show_filters");f("#storeFilters").attr("aria-expanded","true");f(".filterCategoriesButton").addClass("filterShown")};a.prototype.closeFilterCategories=function(h){this.filterOpen=false;f("#filterCategoriesContent").slideToggle(h);f("#filterCategoriesHeader").attr("data-evt-action-id","hide_filters");f("#storeFilters").attr("aria-expanded","false");f(".filterCategoriesButton").removeClass("filterShown")};a.prototype.timerUpdateStoreMap=function(j,k,l){if(j!=undefined&&j!=""&&isStoreStockPopinClosed){return}this.blockMapStrenght-=1;setTimeout(function(){this.timerUpdateStoreMap(j,k,l)}.bind(this),200);var h=this.handlingResize;this.handlingResize=false;if(this.movedByBubbleOpening){this.blockMapStrenght=-1;this.movedByBubbleOpening=false;return""}if(this.blockMapStrenght===0){console.log("mapStoreLocator ==>");console.log(this.mapStoreLocator);if(!this.enableFilterByCategory&&!h){this.enableFilterByCategory=true}if(j==undefined){j=""}if(k==undefined){k=""}this.currentPositionCenter=this.mapStoreLocator.center;this.updateStores(this.getAjaxStoreParameters(this.mapStoreLocator.center,this.mapStoreLocator.getBounds().getNorthEast(),this.mapStoreLocator.getBounds().getSouthWest(),"",j,k,l))}};a.prototype.getAjaxStoreParameters=function(m,h,j,n,k,l,o){return{flagShip:false,latitudeCenter:m.lat(),longitudeCenter:m.lng(),latitudeA:h.lat(),longitudeA:j.lng(),latitudeB:j.lat(),longitudeB:h.lng(),doClosestSearch:this.isUpdatedBySearch,zoomLevel:this.mapStoreLocator.getZoom(),country:n||"",categories:this.getCategoriesChecked(),clickAndCollect:false,productId:k||"",countryId:l||"",osa:o||false}};a.prototype.getCategoriesChecked=function(){var h=[];f("#filterCategoriesContent input:checked").each(function(){h.push(f(this).attr("isearch_lastfilter"))});return h.join(";")};a.prototype.getCountryCode=function(k){if(!this.isUpdatedBySearch||!k.address_components){return""}var h="";for(var j=0;j<k.address_components.length;j++){if(k.address_components[j]){if(k.address_components[j].types[0]==="country"){h=k.address_components[j].short_name}}}return h};a.prototype.updateStores=function(h){console.log("function updateStores");if(this.fromSearch){return}var k=h.longitudeA;var j=h.longitudeB;if(k>j){h.ignoreLongitude=true;h.Nrs="collection()/record[not((location.longitude%3E"+j+")%20and%20((location.longitude%3C"+k+")))]"}this.blockMapStrenght=-1;getAjax(false,"getStoreJson.jsp",function(m){console.log("ajax data : ");console.log(f.parseJSON(m));var l=f.parseJSON(m);this.removeAllMarker();this.closeBubble();this.updateStoreFromJsonString(m)}.bind(this),h)};a.prototype.updateStoreFromJsonString=function(h){this.updateStoreFromJsonObject(f.parseJSON(h))};a.prototype.returnNearestStores=function(){console.log("returnNearestStores");var h=[];var j;for(var k=0;k<allStores.stores.length;k++){j=allStores.stores[k];var n=new google.maps.LatLng(j.latitude,j.longitude);var m=google.maps.geometry.spherical.computeDistanceBetween(this.currentPositionCenter,n);j.distance=m;h[k]=j}h=h.sort(this.predicate());var l=h.splice(0,5);if((this.isUpdatedBySearch)&&((this.currentStoreList.length)==0)){for(var k=0;k<l.length;k++){j=l[k];j.index=k}}console.log("returnedStores : "+l);return l};a.prototype.predicate=function(){return function(j,h){if(parseFloat(j.distance)>parseFloat(h.distance)){return 1}else{if(parseFloat(j.distance)<parseFloat(h.distance)){return -1}}return 0}};a.prototype.updateStoreFromJsonObject=function(h){console.log("function updateStoreFromJsonObject");this.currentjsonObjectList=h;this.currentStoreList=h.stores;this.currentAggregatorList=h.aggregator;if(this.isUpdatedBySearch&&this.currentStoreList.length==0&&(onlyStockAvailable==undefined||onlyStockAvailable==false)){this.currentStoreList=this.returnNearestStores()}if(this.currentStoreList.length==0){f("#locateNoResults").show()}this.displayMarkers();this.displayAggregator();this.displayStoreList();this.updateBounds();this.saveCurrentStateInLocalStorage();if(onlyStockAvailable!=undefined){if(correspondingStoreInList!=""){scrollToCorrespondingStoreInList(correspondingStoreInList)}}};a.prototype.saveCurrentStateInLocalStorage=function(){if(this.enableSavedLocalStorage){f.jStorage.set("storeLocatorState",{lat:this.mapStoreLocator.getCenter().lat(),lng:this.mapStoreLocator.getCenter().lng(),zoom:this.mapStoreLocator.getZoom(),inputText:getInputTextElement().val(),filterOpen:this.filterOpen,categoriesChecked:this.getCategoriesChecked(),storeJson:this.currentjsonObjectList})}};function b(j){var h=j.coords;f("body .storeList").find("li").each(function(){var m=f(this);var n=m.find("article").attr("data-latitude");var l=m.find("article").attr("data-longitude");var k="//maps.google.com/maps?saddr="+h.latitude+","+h.longitude+"&daddr="+n+","+l;m.find(".driving-directions").css("display","inline-block").attr("href",k)})}a.prototype.displayStoreList=function(){var h='<ul id="ul-storeList" class="storeList">';console.log("this.currentStoreList ==> ");console.log(this.currentStoreList);f("#storeListTemplate").tmpl(this.currentStoreList).each(function(){h+=f(this).wrap("<div></div>").parent().html()});h+="</ul>";if(onlyStockAvailable!=undefined){setTimeout(function(){loadingExpands()},1000);if(navigator.geolocation){navigator.geolocation.getCurrentPosition(b)}f(".locate-map-loader").addClass("hide")}f("body #storeList").html(h);f(".modal_tc").css("height","90%");bindRemovePage("#storeList a");this.displayStoreListTitle(OURSTORES);f("#filterCategoriesWrapper").show()};a.prototype.handleShadowHeight=function(){var h=storeMap.iScrollList.y;if(h>=0){this.shadowTopScoller.height(0)}else{if(h<=0&&h>=-20){this.shadowTopScoller.height(-h/2)}else{this.shadowTopScoller.height(10)}}};a.prototype.removeAllMarker=function(){var h;for(h=0;h<this.markerStoreLocator.length;h++){if(this.markerStoreLocator[h]){this.markerStoreLocator[h].setMap(null)}}for(h=0;h<this.markerAggregator.length;h++){this.markerAggregator[h].setMap(null)}};a.prototype.displayMarkers=function(){var n=[],h,m;function k(o,p){return function(){p.openInfoBubble(o,false);var q={actionPosition:"stores_map",actionType:"navigation",actionId:"store_pin_selection",storeId:p.currentStoreList[o].dataName,storeCity:p.currentStoreList[o].city,storeCountry:p.currentStoreList[o].country};if(onlyStockAvailable!=undefined){q.productSku=f(".locate-product-info").find(".sku").text().trim()}autoDataSend(q)}}if(onlyStockAvailable!=undefined){var j=true}for(i=0;i<this.currentStoreList.length;i++){if(this.currentStoreList[i].callCenter==="false"){n[i]=new google.maps.LatLng(this.currentStoreList[i].latitude,this.currentStoreList[i].longitude);if(j){if(this.currentStoreList[i].stockAvailability=="true"){var l=IMAGE_PIN_STORE_PRODUCT_AVAILABLE}else{if(this.currentStoreList[i].stockAvailability=="false"){var l=IMAGE_PIN_STORE_PRODUCT_NOT_AVAILABLE}else{if(this.currentStoreList[i].stockAvailability=="na"){var l=IMAGE_PIN_STORE_INFORMATION_NOT_AVAILABLE}else{var l=IMAGE_PIN_STORE}}}}this.markerStoreLocator[i]=new google.maps.Marker({position:n[i],map:this.mapStoreLocator,icon:j==true?(l):this.currentStoreList[i].flagship==="true"?IMAGE_PIN_FLAGSHIP:IMAGE_PIN_STORE,title:this.currentStoreList[i].name});this.newBounds.extend(n[i]);google.maps.event.addListener(this.markerStoreLocator[i],"click",k(i,this))}}};a.prototype.getbubbleContent=function(h){h.isSmartphone=RESPONSIVE_MANAGER.isAllSmallMode();return f("#bubbleStoreTemplate").tmpl(h).wrap("<div><div/>").parent().html()};a.prototype.openInfoBubble=function(j,s){var k,n=RESPONSIVE_MANAGER.isAllSmallMode()?5:20,p=RESPONSIVE_MANAGER.isAllSmallMode()?245:403,r=!s?this.currentStoreList[j]:this.currentAggregatorList[j];f(window).trigger("infoBubbleOpened",{storeId:r.storeId,name:r.name,isAggregator:s,index:j});console.log("currentStoreList : ");console.log(this.currentStoreList[j]);this.closeBubble();if(!s){var m=this.getbubbleContent(this.currentStoreList[j]),h=getHeightBeforeRender(m,p);k=new google.maps.LatLng(this.currentStoreList[j].latitude,this.currentStoreList[j].longitude);this.infoBubble=new InfoBubble({content:m,shadowStyle:1,padding:n,borderRadius:1,borderWidth:0,arrowSize:10,minHeight:h,maxHeight:h,maxWidth:p,minWidth:p,disableAnimation:true,disableAutoPan:false,hideCloseButton:false,arrowPosition:50,backgroundClassName:"storeBubble",arrowStyle:0});var o=this.currentStoreList[j].latitude;var q=this.currentStoreList[j].longitude;this.infoBubble.open(this.mapStoreLocator,this.markerStoreLocator[j]);f(window).trigger("infoBubble",{name:this.currentStoreList[j].name});function l(v){var u=v.coords;var t="//maps.google.com/maps?saddr="+u.latitude+","+u.longitude+"&daddr="+o+","+q;f(".locate-bubbleStore").find(".driving-directions").css("display","inline-block").attr("href",t)}if(onlyStockAvailable!=undefined){if(navigator.geolocation){navigator.geolocation.getCurrentPosition(l)}}}else{k=new google.maps.LatLng(this.currentAggregatorList[j].latitude,this.currentAggregatorList[j].longitude);this.infoBubble=new InfoBubble({content:'<h3 id="storeAgregator">'+this.currentAggregatorList[j].name+"</h3>",shadowStyle:1,padding:5,borderRadius:1,arrowSize:10,borderWidth:0,minHeight:0,minWidth:0,maxHeight:h,disableAnimation:true,disableAutoPan:false,hideCloseButton:true,arrowPosition:50,backgroundClassName:"storeBubbleAgregator",arrowStyle:0});this.infoBubble.open(this.mapStoreLocator,this.markerAggregator[j]);bindRemovePage(".bubbleButton a")}this.movedByBubbleOpening=true};a.prototype.handleTitleAggregatorClick=function(){this.mapStoreLocator.setZoom(this.mapStoreLocator.getZoom()+1)};a.prototype.displayAggregator=function(){var k=[],j=new google.maps.MarkerImage(CONFIGURATION.TECH_ASSETS_PATH+"store/aggregator.png",new google.maps.Size(31,31));function h(l,m){return function(){m.openInfoBubble(l,true)}}for(i=0;i<this.currentAggregatorList.length;i++){k[i]=new google.maps.LatLng(this.currentAggregatorList[i].latitude,this.currentAggregatorList[i].longitude);this.markerAggregator[i]=new google.maps.Marker({position:k[i],map:this.mapStoreLocator,icon:j,title:this.currentAggregatorList[i].name});this.newBounds.extend(k[i]);google.maps.event.addListener(this.markerAggregator[i],"click",h(i,this))}};a.prototype.updateBounds=function(){this.shadowTopScoller.height(0);if(this.isUpdatedBySearch){if(!this.fromSearch){this.currentPositionMarker=new google.maps.Marker({map:this.mapStoreLocator,position:this.mapStoreLocator.getCenter()})}if(onlyStockAvailable==undefined||this.currentStoreList.length>0){var l=true;for(var k=0;k<this.currentStoreList.length;k++){var h=this.currentStoreList[k],j=new google.maps.LatLng(h.latitude,h.longitude);if(!this.mapStoreLocator.getBounds().contains(j)){l=false;break}}if(!l||(!this.mapStoreLocator.getBounds().contains(this.newBounds.getNorthEast())&&!this.mapStoreLocator.getBounds().contains(this.newBounds.getSouthWest()))){this.newBounds.extend(this.mapStoreLocator.getCenter());this.mapStoreLocator.fitBounds(this.newBounds);this.blockMapStrenght=-1}}this.isUpdatedBySearch=false}this.newBounds=new google.maps.LatLngBounds()};a.prototype.closeBubble=function(){if(this.infoBubble){this.infoBubble.close()}};function g(){this.cgiPosition=null;this.currentPositionCenter=null;this.positionResult=null;this.isUpdatedBySearch=false}function e(){loadingImgs();var h=f(".storeBubbleAgregator").parent();h.css("cursor","pointer");h.unbind();h.click(storeMap.handleTitleAggregatorClick.bind(storeMap))}window.StoreMap=a;window.StoreMapOption=g;window.callBackBubbleOpener=e})(jQuery);